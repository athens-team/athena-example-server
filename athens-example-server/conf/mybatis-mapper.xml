<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
/*
 * Copyright 2012 Athens Team
 *
 * This file to you under the Apache License, version 2.0
 * (the "License"); you may not use this file except in compliance with the
 * License.  You may obtain a copy of the License at:
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 */ 
 -->
<mapper namespace="net.rothlee.athens.olympus.db.OlympusMapper">

	<!-- result maps -->
	<resultMap id="userResult" type="User">
		<id column="id" property="id" />
		<result column="email_addr" property="emailAddr" />
		<result column="nickname" property="nickname" />
		<result column="bio" property="bio" />
		<result column="created_time" property="createdTime"
			typeHandler="TimestampTypeHandler" />
	</resultMap>

	<resultMap id="sessionResult" type="Session">
		<id column="id" property="id" />
		<result column="uuid" property="uuid" />
		<result column="user_id" property="userId" />
		<result column="tag" property="tag" />
		<result column="created_time" property="createdTime"
			typeHandler="TimestampTypeHandler" />
	</resultMap>

	<resultMap id="postResult" type="Post">
		<id column="id" property="id" />
		<result column="user_id" property="userId" />
		<result column="content" property="content" />
		<result column="created_time" property="createdTime"
			typeHandler="TimestampTypeHandler" />
	</resultMap>

	<!-- user operations -->
	<insert id="insertUser" parameterType="User">
		INSERT INTO omp_user ( profile, email_addr, nickname )
		values ( #{profile}, #{emailAddr}, #{nickname} )
	</insert>

	<delete id="deleteUser" parameterType="User">
		DELETE FROM omp_user
		WHERE id = #{id}
	</delete>

	<update id="updateUser" parameterType="User">
		UPDATE omp_user
		SET device_id = #{deviceId}, profile = #{profile}, email_addr
		= #{emailAddr}, nickname = #{nickname}
		WHERE id = #{id}
	</update>

	<select id="getUser" parameterType="User" resultMap="userResult"
		timeout="10000">
		SELECT id, profile, email_addr, nickname, created_time
		FROM
		omp_user
		WHERE id = #{id}
	</select>

	<select id="getUserByEmail" parameterType="User" resultMap="userResult"
		timeout="10000">
		SELECT id, profile, email_addr, nickname, created_time
		FROM
		omp_user
		WHERE email_addr = #{emailAddr}
	</select>

	<!-- session operations -->
	<insert id="insertSession" parameterType="Session">
		INSERT INTO omp_session ( user_id, uuid, tag )
		values ( #{userId}, #{uuid}, #{tag} )
	</insert>

	<select id="getSessionByUUID" parameterType="Session" resultMap="sessionResult"
		timeout="10000">
		SELECT id, uuid, tag, created_time
		FROM omp_session
		WHERE uuid =
		#{uuid}
	</select>

	<!-- post operations -->
	<insert id="insertPost" parameterType="Post">
		INSERT INTO omp_post ( user_id, content )
		values ( #{userId}, #{content} )
	</insert>

	<delete id="deletePost" parameterType="Post">
		DELETE FROM omp_post
		WHERE id = #{id}
	</delete>

	<select id="getPosts" parameterType="Range" resultMap="postResult"
		timeout="10000">
		SELECT id, user_id, content, created_time
		FROM omp_post
		WHERE id
		&lt; #{afterId} AND id &gt; #{beforeId}
		ORDER BY id DESC
		LIMIT #{limit}
	</select>

</mapper>